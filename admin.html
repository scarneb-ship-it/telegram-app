<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Games Verse</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --primary: #667eea;
    --primary-dark: #5a6fd8;
    --success: #48bb78;
    --danger: #f56565;
    --warning: #ed8936;
    --info: #4299e1;
    --dark: #2d3748;
    --light: #f7fafc;
    --border: #e2e8f0;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Login Screen */
.login-container {
    background: white;
    padding: 40px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 400px;
    animation: fadeIn 0.5s ease;
}

.login-header {
    text-align: center;
    margin-bottom: 30px;
}

.login-header h1 {
    font-size: 28px;
    color: var(--dark);
    margin-bottom: 8px;
}

.login-header p {
    color: #718096;
    font-size: 14px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
    font-size: 14px;
}

.form-group input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.login-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.error-message {
    background: #fff5f5;
    color: var(--danger);
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    margin-top: 15px;
    display: none;
}

.error-message.show {
    display: block;
}

/* Admin Dashboard */
.admin-container {
    display: none;
    width: 100%;
    max-width: 1400px;
    padding: 20px;
}

.admin-container.active {
    display: block;
}

.admin-header {
    background: white;
    padding: 20px 30px;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-header h1 {
    font-size: 28px;
    color: var(--dark);
}

.admin-header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
}

.refresh-btn, .logout-btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.refresh-btn {
    background: var(--info);
    color: white;
}

.refresh-btn:hover {
    background: #3182ce;
    transform: translateY(-2px);
}

.logout-btn {
    background: var(--danger);
    color: white;
}

.logout-btn:hover {
    background: #e53e3e;
    transform: translateY(-2px);
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-icon.primary {
    background: rgba(102, 126, 234, 0.1);
}

.stat-icon.success {
    background: rgba(72, 187, 120, 0.1);
}

.stat-icon.warning {
    background: rgba(237, 137, 54, 0.1);
}

.stat-icon.info {
    background: rgba(66, 153, 225, 0.1);
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 4px;
}

.stat-label {
    color: #718096;
    font-size: 14px;
    font-weight: 500;
}

/* Users Table */
.table-container {
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 24px;
}

.table-header {
    padding: 20px 30px;
    border-bottom: 2px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-header h2 {
    font-size: 20px;
    color: var(--dark);
}

.search-box {
    padding: 8px 16px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    width: 250px;
}

.search-box:focus {
    outline: none;
    border-color: var(--primary);
}

.users-table {
    width: 100%;
    border-collapse: collapse;
}

.users-table thead {
    background: var(--light);
}

.users-table th {
    padding: 16px 24px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    color: var(--dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.users-table td {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    font-size: 14px;
    color: var(--dark);
}

.users-table tbody tr {
    transition: background 0.2s ease;
}

.users-table tbody tr:hover {
    background: #f7fafc;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 16px;
}

.user-details {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.user-username {
    font-size: 12px;
    color: #718096;
}

.badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
}

.badge.success {
    background: rgba(72, 187, 120, 0.1);
    color: var(--success);
}

.badge.warning {
    background: rgba(237, 137, 54, 0.1);
    color: var(--warning);
}

.badge.info {
    background: rgba(66, 153, 225, 0.1);
    color: var(--info);
}

.loading {
    text-align: center;
    padding: 40px;
    color: #718096;
}

.loading-spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #718096;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        gap: 16px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .table-header {
        flex-direction: column;
        gap: 12px;
    }

    .search-box {
        width: 100%;
    }

    .users-table {
        font-size: 12px;
    }

    .users-table th,
    .users-table td {
        padding: 12px 16px;
    }
}
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-container" id="loginContainer">
<div class="login-header">
<h1>üîê Admin Panel</h1>
<p>Games Verse Administration</p>
</div>
<form id="loginForm">
<div class="form-group">
<label for="username">–õ–æ–≥–∏–Ω</label>
<input type="text" id="username" required autocomplete="username">
</div>
<div class="form-group">
<label for="password">–ü–∞—Ä–æ–ª—å</label>
<input type="password" id="password" required autocomplete="current-password">
</div>
<button type="submit" class="login-btn">–í–æ–π—Ç–∏</button>
<div class="error-message" id="errorMessage">–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å</div>
</form>
</div>

<!-- Admin Dashboard -->
<div class="admin-container" id="adminContainer">
<!-- Header -->
<div class="admin-header">
<h1>üìä Dashboard</h1>
<div class="admin-header-actions">
<button class="refresh-btn" onclick="loadDashboardData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
<button class="logout-btn" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
</div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-value" id="totalUsers">0</div>
<div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
</div>
<div class="stat-icon primary">üë•</div>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-value" id="totalGamesOpened">0</div>
<div class="stat-label">–û—Ç–∫—Ä—ã—Ç–æ –∏–≥—Ä</div>
</div>
<div class="stat-icon success">üéÆ</div>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-value" id="totalReferrals">0</div>
<div class="stat-label">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
</div>
<div class="stat-icon warning">üîó</div>
</div>
</div>

<div class="stat-card">
<div class="stat-header">
<div>
<div class="stat-value" id="avgStreak">0</div>
<div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Å—Ç—Ä–∏–∫</div>
</div>
<div class="stat-icon info">üî•</div>
</div>
</div>
</div>

<!-- Users Table -->
<div class="table-container">
<div class="table-header">
<h2>üë• –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
<input type="text" class="search-box" id="searchBox" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
</div>
<div id="tableContent">
<div class="loading">
<div class="loading-spinner"></div>
<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>
</div>
</div>
</div>

<script>
const API_BASE_URL = window.location.origin + '/api';

// Admin credentials
const ADMIN_USERNAME = 'Scarnep';
const ADMIN_PASSWORD = '0163087375—Å';

// Login handler
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
        // Store auth token
        sessionStorage.setItem('adminAuth', 'true');
        
        // Hide login, show dashboard
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('adminContainer').classList.add('active');
        
        // Load data
        loadDashboardData();
    } else {
        document.getElementById('errorMessage').classList.add('show');
        setTimeout(() => {
            document.getElementById('errorMessage').classList.remove('show');
        }, 3000);
    }
});

// Check if already logged in
window.addEventListener('DOMContentLoaded', function() {
    if (sessionStorage.getItem('adminAuth') === 'true') {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('adminContainer').classList.add('active');
        loadDashboardData();
    }
});

// Logout handler
function logout() {
    sessionStorage.removeItem('adminAuth');
    location.reload();
}

// Load dashboard data
async function loadDashboardData() {
    try {
        // Fetch all users
        const response = await fetch(`${API_BASE_URL}/admin/users`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch users');
        }
        
        const users = await response.json();
        
        // Update statistics
        updateStatistics(users);
        
        // Render users table
        renderUsersTable(users);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('tableContent').innerHTML = `
            <div class="no-data">
                <p>‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
                <p style="font-size: 12px; margin-top: 8px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API</p>
            </div>
        `;
    }
}

// Update statistics
function updateStatistics(users) {
    const totalUsers = users.length;
    const totalGamesOpened = users.reduce((sum, user) => sum + (user.games_opened || 0), 0);
    const totalReferrals = users.reduce((sum, user) => sum + (user.friends_invited || 0), 0);
    const avgStreak = totalUsers > 0 
        ? Math.round(users.reduce((sum, user) => sum + (user.streak_days || 0), 0) / totalUsers) 
        : 0;
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('totalGamesOpened').textContent = totalGamesOpened;
    document.getElementById('totalReferrals').textContent = totalReferrals;
    document.getElementById('avgStreak').textContent = avgStreak;
}

// Render users table
function renderUsersTable(users) {
    if (users.length === 0) {
        document.getElementById('tableContent').innerHTML = `
            <div class="no-data">
                <p>üì≠ –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            </div>
        `;
        return;
    }
    
    // Sort users by referrals count (descending)
    const sortedUsers = [...users].sort((a, b) => 
        (b.friends_invited || 0) - (a.friends_invited || 0)
    );
    
    const tableHTML = `
        <table class="users-table">
            <thead>
                <tr>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>Telegram ID</th>
                    <th>üéÆ –ò–≥—Ä—ã</th>
                    <th>üî• –°—Ç—Ä–∏–∫</th>
                    <th>üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</th>
                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                </tr>
            </thead>
            <tbody>
                ${sortedUsers.map(user => `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    ${(user.first_name || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="user-details">
                                    <div class="user-name">${user.first_name || 'Unknown'} ${user.last_name || ''}</div>
                                    <div class="user-username">${user.username ? '@' + user.username : 'No username'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${user.telegram_id}</td>
                        <td><span class="badge info">${user.games_opened || 0}</span></td>
                        <td><span class="badge warning">${user.streak_days || 0}</span></td>
                        <td><span class="badge success">${user.friends_invited || 0}</span></td>
                        <td>${formatDate(user.created_at)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    document.getElementById('tableContent').innerHTML = tableHTML;
    
    // Setup search functionality
    setupSearch(sortedUsers);
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 1) return '–í—á–µ—Ä–∞';
    if (diffDays < 7) return `${diffDays} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
    
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Setup search
function setupSearch(users) {
    const searchBox = document.getElementById('searchBox');
    
    searchBox.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        
        if (searchTerm === '') {
            renderUsersTable(users);
            return;
        }
        
        const filteredUsers = users.filter(user => {
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.toLowerCase();
            const username = (user.username || '').toLowerCase();
            const telegramId = (user.telegram_id || '').toLowerCase();
            
            return fullName.includes(searchTerm) || 
                   username.includes(searchTerm) || 
                   telegramId.includes(searchTerm);
        });
        
        renderUsersTable(filteredUsers);
    });
}
</script>

</body>
</html>
